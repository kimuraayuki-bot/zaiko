<style>
  /* 繧ｫ繝ｬ繝ｳ繝繝ｼ蟆ら畑縺ｮ繧ｹ繧ｿ繧､繝ｫ */
  .chart-area { width: 100%; height: 180px; margin-top: 15px; }
  .cal-header { display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 16px; margin-bottom: 15px; color: #333; }
  .cal-header button { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 5px 15px; cursor: pointer; font-weight: 800; color: #666; transition: 0.2s; }
  .cal-header button:active { background: #f0f0f0; }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 5px; }
  .cal-day-header { font-size: 11px; color: #888; font-weight: 800; margin-bottom: 5px; }
  .cal-day { padding: 8px 0; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 40px; transition: 0.2s; }
  .cal-day:active { background: var(--light-blue); }
  .cal-date { font-size: 14px; font-weight: 800; color: #333; }
  
  /* 繧ｫ繝ｬ繝ｳ繝繝ｼ縺ｮ繝槭・繧ｯ(笳・ */
  .cal-indicators { display: flex; gap: 3px; margin-top: 3px; min-height: 6px; }
  .dot-plan { width: 6px; height: 6px; background-color: var(--main-blue); border-radius: 50%; }
  .dot-perf { width: 6px; height: 6px; background-color: var(--red-text); border-radius: 50%; }
  
  /* 繝｢繝ｼ繝繝ｫ縺ｮ髢峨§繧九・繧ｿ繝ｳ */
  .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; font-weight: 800; color: #999; cursor: pointer; }
</style>
<div class="section-title">在庫推移トレンド</div>
<div class="section-body">
  <div class="card">
    <label>表示対象</label>
    <select id="chart-item-select" onchange="drawTrendChart()"></select>

    <label>表示期間</label>
    <select id="chart-period" onchange="drawTrendChart()">
      <option value="30">過去30日</option>
      <option value="7">過去7日</option>
    </select>

    <div id="trend-chart" class="chart-area"></div>
  </div>
</div>

<div class="section-title" style="margin-top:20px;">予定カレンダー</div>
<div class="section-body">
  <div class="card">
    <div class="cal-header">
      <button onclick="changeMonth(-1)">&lt;&lt;</button>
      <span id="cal-title"></span>
      <button onclick="changeMonth(1)">&gt;&gt;</button>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
  </div>
</div>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
google.charts.load('current', { packages: ['corechart'] });

let currentCalDate = new Date();
let calendarData = { events: {} };

function refreshCalendar() {
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(data => {
    calendarData = data || { events: {} };
    google.script.run.withFailureHandler(handleGsError).withSuccessHandler(master => {
      load(false);
      const select = document.getElementById('chart-item-select');
      select.innerHTML = (master.masterAll || []).map(it => `<option value="${it.name}">${it.name}</option>`).join('');
      renderCalendar();
      drawTrendChart();
    }).getInitialData();
  }).getCalendarData();
}

function renderCalendar() {
  const y = currentCalDate.getFullYear();
  const m = currentCalDate.getMonth();
  document.getElementById('cal-title').innerText = `${y}年 ${m + 1}月`;

  const dayHeaders = ['日','月','火','水','木','金','土'];
  let html = dayHeaders.map(d => `<div class="cal-day-header">${d}</div>`).join('');

  const firstDay = new Date(y, m, 1).getDay();
  const lastDate = new Date(y, m + 1, 0).getDate();

  for (let i = 0; i < firstDay; i++) html += '<div></div>';

  const today = new Date();
  for (let d = 1; d <= lastDate; d++) {
    const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    const evs = (calendarData.events && calendarData.events[ds]) ? calendarData.events[ds] : [];
    const hasPerf = evs.some(e => Number(e.qty) !== 0);
    const hasPlan = evs.some(e => Number(e.qty) === 0);

    const isToday = y === today.getFullYear() && m === today.getMonth() && d === today.getDate();
    const bgStyle = isToday ? 'background:#f0f8ff;' : '';
    const txtStyle = isToday ? 'color:var(--main-blue);' : '';

    let dotsHtml = '';
    if (hasPlan) dotsHtml += '<div class="dot-plan"></div>';
    if (hasPerf) dotsHtml += '<div class="dot-perf"></div>';

    html += `
      <div class="cal-day" style="${bgStyle}" onclick="openDateDetail('${ds}')">
        <span class="cal-date" style="${txtStyle}">${d}</span>
        <div class="cal-indicators">${dotsHtml}</div>
      </div>
    `;
  }

  document.getElementById('cal-grid').innerHTML = html;
}

function changeMonth(diff) {
  currentCalDate.setMonth(currentCalDate.getMonth() + diff);
  renderCalendar();
}

function openDateDetail(ds) {
  const evs = (calendarData.events && calendarData.events[ds]) ? calendarData.events[ds] : [];
  const perfs = evs.filter(e => Number(e.qty) !== 0);
  const plans = evs.filter(e => Number(e.qty) === 0);

  const dateObj = new Date(ds);
  const displayDate = `${dateObj.getFullYear()}年 ${dateObj.getMonth() + 1}月${dateObj.getDate()}日`;

  const perfHtml = perfs.length > 0
    ? perfs.map(e => `・${e.name} <span style="color:var(--red-text); font-weight:800;">${e.qty}${e.unit || ''}</span><br>`).join('')
    : '実績はありません';

  const planHtml = plans.length > 0
    ? plans.map(e => `・${e.name}<br>`).join('')
    : '予定はありません';

  const html = `
    <button class="close-btn" onclick="closeModal()">×</button>
    <div style="font-weight:800; text-align:center; margin-bottom:20px; color:#333; font-size:16px;">${displayDate}</div>

    <div style="font-size:13px; font-weight:800; color:#555; margin-bottom:8px;">在庫実績</div>
    <div style="border-top:1px solid #eee; padding-top:10px; margin-bottom:20px; font-size:13px; color:#666; line-height:1.6;">${perfHtml}</div>

    <div style="font-size:13px; font-weight:800; color:#555; margin-bottom:8px;">予定</div>
    <div style="border-top:1px solid #eee; padding-top:10px; font-size:13px; color:#666; line-height:1.6;">${planHtml}</div>

    <button class="btn-action" onclick="openAddPlan('${ds}', '${displayDate}')">＋ 予定を追加</button>
  `;
  openModal(html);
}

function openAddPlan(ds, displayDate) {
  const html = `
    <div style="font-weight:800; text-align:center; margin-bottom:20px; color:#333; font-size:16px;">新規予定</div>
    <div style="background:#f9f9f9; padding:15px; border-radius:12px; border:1px solid #eee; margin-bottom:20px;">
      <div style="font-size:12px; font-weight:800; color:#888; margin-bottom:5px;">日付</div>
      <div style="font-size:14px; font-weight:800; color:#333; margin-bottom:15px;">${displayDate}</div>
      <div style="font-size:12px; font-weight:800; color:#888; margin-bottom:5px;">内容</div>
      <input type="text" id="new-plan-title" placeholder="予定内容を入力">
    </div>
    <button class="btn-main" onclick="executeAddPlan('${ds}')">保存</button>
    <button class="btn-cancel" onclick="openDateDetail('${ds}')">キャンセル</button>
  `;
  openModal(html);
}

function executeAddPlan(ds) {
  const title = document.getElementById('new-plan-title').value;
  if (!title) return;
  closeModal();
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(() => {
    load(false);
    toast('予定を保存しました');
    refreshCalendar();
  }).addCalendarEvent({ date: ds, title: title });
}

function drawTrendChart() {
  const container = document.getElementById('trend-chart');
  container.innerHTML = '<div style="background: #f8f9fa; border: 2px dashed #cbd5e1; border-radius: 12px; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #aaa; font-size: 12px;">在庫推移グラフは準備中です</div>';
}
</script>



