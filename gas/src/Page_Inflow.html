<div class="section-title">レシート画像解析（AI）</div>
<div class="section-body">
  <div class="camera-box" onclick="document.getElementById('cam-in').click()">
    <div style="font-size: 32px; margin-bottom: 5px;">📷</div>
    <div style="font-weight: 800; color: #555; font-size: 14px;">レシート画像をスキャン</div>
    <input type="file" id="cam-in" style="display:none;" onchange="startAI(this)">
  </div>
</div>

<div class="section-title" style="margin-top: 30px;">手動入庫登録</div>
<div class="section-body">
  <div class="card">
    <div style="flex: 2;">
      <label>アイテム</label>
      <select id="manual-in-name" onchange="updateManualInUnit()"></select>
      <div style="margin-top:8px;">
        <label>数量</label>
        <div class="qty-input-box">
          <input type="number" id="manual-in-qty" value="">
          <span id="manual-in-unit" class="unit-label">--</span>
        </div>
        <select id="manual-in-input-unit" style="margin-top:8px;"></select>
      </div>
    </div>
    <div style="flex: 1; display: flex; justify-content: flex-end;">
      <button class="btn-action" onclick="confirmManualIn()">入庫登録</button>
    </div>
  </div>
</div>
<script>
let mIn = [];

function refreshInflow() {
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(d => {
    load(false);
    mIn = d.masterAll || [];
    const opts = mIn.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
    document.getElementById('manual-in-name').innerHTML = opts;
    updateManualInUnit();
  }).getInitialData();
}

function updateManualInUnit() {
  const m = mIn.find(x => x.name === document.getElementById('manual-in-name').value);
  document.getElementById('manual-in-unit').innerText = m ? m.unit : '--';
  const units = (m && Array.isArray(m.unitOptions) && m.unitOptions.length > 0) ? m.unitOptions : (m ? [m.unit] : ['--']);
  document.getElementById('manual-in-input-unit').innerHTML = units.map(u => `<option value="${u}">${u}</option>`).join('');
}

function startAI(input) {
  if (!input.files[0]) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result.split(',')[1];
    load(true);
    google.script.run.withFailureHandler(handleGsError).withSuccessHandler(result => {
      load(false);
      if (result && result.length > 0) {
        showAIResultPopup(result);
      } else {
        alert('解析結果が取得できませんでした');
      }
    }).analyzeReceiptAI(base64);
  };
  reader.readAsDataURL(input.files[0]);
}

function showAIResultPopup(resultList) {
  const itemsHtml = resultList.map(item => `
    <div style="background:#fff; border:1px solid #eee; padding:12px; border-radius:12px; margin-bottom:10px; display:flex; align-items:center; gap:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
      <div style="flex:2;">
        <div style="font-size:13px; font-weight:800; color:#444;">${item.name}</div>
        <div style="color:var(--main-blue); font-weight:800;">${item.qty} <span style="font-size:11px; color:#777;">セット</span></div>
      </div>
      <div style="font-size:10px; color:#aaa; font-weight:bold;">AI</div>
    </div>
  `).join('');

  const escaped = JSON.stringify(resultList).replace(/"/g, '&quot;');
  const html = `
    <div style="font-weight:800; text-align:center; margin-bottom:15px; color:#333; font-size:18px;">解析結果</div>
    <p style="font-size:12px; color:#666; text-align:center; margin-bottom:15px;">内容を確認して登録してください</p>
    <div style="max-height: 250px; overflow-y: auto; padding: 5px;">${itemsHtml}</div>
    <div style="margin-top:20px;">
      <button class="btn-main" onclick="executeAIIn('${escaped}')">登録する</button>
      <button class="btn-cancel" onclick="closeModal()">戻る</button>
    </div>
  `;
  openModal(html);
}

function executeAIIn(jsonStr) {
  const dataList = JSON.parse(jsonStr);
  closeModal();
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(res => {
    load(false);
    toast(res);
  }).processAIInflow(dataList);
}

function confirmManualIn() {
  const name = document.getElementById('manual-in-name').value;
  const qty = document.getElementById('manual-in-qty').value;
  const inputUnit = document.getElementById('manual-in-input-unit').value;
  const m = mIn.find(x => x.name === name);
  if (!qty || !m) return;

  const html = `
    <div style="font-weight:800; text-align:center; margin-bottom:20px; color:#333; font-size:18px;">入庫確認</div>
    <div style="background:#f9f9f9; padding:18px; border-radius:16px; font-size:14px; color:#444; border: 1px solid #eee; text-align:center;">
      <div style="font-weight:800; margin-bottom:10px; font-size:16px;">${name}</div>
      <div><span style="color:var(--main-blue); font-size:24px; font-weight:800;">+ ${qty}</span><span style="font-size:14px; font-weight:800; color:#777;"> ${inputUnit}</span></div>
    </div>
    <div style="margin-top:20px;">
      <button class="btn-main" onclick="executeManualIn('${name}', ${qty}, '${inputUnit}')">登録する</button>
      <button class="btn-cancel" onclick="closeModal()">キャンセル</button>
    </div>
  `;
  openModal(html);
}

function executeManualIn(name, qty, inputUnit) {
  closeModal();
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(res => {
    load(false);
    toast(res);
    document.getElementById('manual-in-qty').value = '';
  }).processInflowFromUI({ name: name, qty: qty, inputUnit: inputUnit, memo: '手動入庫', isSet: false });
}
</script>


