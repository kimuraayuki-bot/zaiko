<div class="section-title">レシート画像解析（AI）</div>
<div class="section-body">
  <div class="camera-box" onclick="document.getElementById('cam-in').click()">
    <div style="font-size: 32px; margin-bottom: 5px;">📷</div>
    <div style="font-weight: 800; color: #555; font-size: 14px;">レシート画像をスキャン</div>
    <input type="file" id="cam-in" style="display:none;" onchange="onReceiptSelected(this)">
  </div>
  <button class="btn-main" style="margin-top:10px;" onclick="startAI()">AI解析を実行</button>
</div>

<div class="section-title" style="margin-top: 30px;">手動入庫登録</div>
<div class="section-body">
  <div class="card">
    <div style="flex: 2;">
      <label>アイテム</label>
      <select id="manual-in-name" onchange="updateManualInUnit()"></select>
      <div style="margin-top:8px;">
        <label>数量</label>
        <div class="qty-input-box">
          <input type="number" id="manual-in-qty" value="">
          <span id="manual-in-unit" class="unit-label">--</span>
        </div>
        <select id="manual-in-input-unit" style="margin-top:8px;"></select>
      </div>
    </div>
    <div style="flex: 1; display: flex; justify-content: flex-end;">
      <button class="btn-action" onclick="confirmManualIn()">入庫登録</button>
    </div>
  </div>
</div>
<script>
let mIn = [];
let aiReceiptBase64 = '';
let aiInDraft = [];

function refreshInflow() {
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(d => {
    load(false);
    mIn = d.masterAll || [];
    const opts = mIn.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
    document.getElementById('manual-in-name').innerHTML = opts;
    updateManualInUnit();
  }).getInitialData();
}

function updateManualInUnit() {
  const m = mIn.find(x => x.name === document.getElementById('manual-in-name').value);
  document.getElementById('manual-in-unit').innerText = m ? m.unit : '--';
  const units = (m && Array.isArray(m.unitOptions) && m.unitOptions.length > 0) ? m.unitOptions : (m ? [m.unit] : ['--']);
  document.getElementById('manual-in-input-unit').innerHTML = units.map(u => `<option value="${u}">${u}</option>`).join('');
}

function onReceiptSelected(input) {
  if (!input || !input.files || !input.files[0]) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    aiReceiptBase64 = e.target.result.split(',')[1] || '';
    toast('画像を選択しました。AI解析を実行してください');
  };
  reader.readAsDataURL(input.files[0]);
}

function startAI() {
  if (!aiReceiptBase64) {
    alert('先に画像ファイルを選択してください');
    return;
  }
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(result => {
    load(false);
    if (result && result.length > 0) {
      showAIResultPopup(result);
    } else {
      alert('解析結果が取得できませんでした');
    }
  }).analyzeReceiptAI(aiReceiptBase64);
}

function aiNorm(text) {
  return String(text || '').toLowerCase().replace(/\s+/g, '').replace(/[()（）\-ー_\/]/g, '');
}

function aiFindBestMaster(aiName) {
  const n = aiNorm(aiName);
  if (!n) return { match: null, status: '未該当', score: 0 };
  let best = null;
  let bestScore = 0;
  (mIn || []).forEach(m => {
    const mn = aiNorm(m.name);
    let score = 0;
    if (n === mn) score = 100;
    else if (n.includes(mn) || mn.includes(n)) score = 70;
    else {
      let hit = 0;
      for (const ch of n) if (mn.includes(ch)) hit++;
      score = Math.floor((hit / Math.max(n.length, 1)) * 40);
    }
    if (score > bestScore) {
      best = m;
      bestScore = score;
    }
  });
  if (!best || bestScore < 50) return { match: null, status: '未該当', score: bestScore };
  return { match: best, status: bestScore >= 95 ? '一致' : '候補', score: bestScore };
}

function aiBuildDraft(resultList) {
  return (resultList || []).map(item => {
    const found = aiFindBestMaster(item.name);
    const m = found.match;
    const units = m ? ((m.unitOptions && m.unitOptions.length) ? m.unitOptions : [m.unit]) : [];
    return {
      aiName: item.name || '',
      qty: Number(item.qty) || 0,
      targetName: m ? m.name : '',
      category: m ? m.category : '',
      inputUnit: units[0] || '',
      status: found.status
    };
  });
}

function showAIResultPopup(resultList) {
  aiInDraft = aiBuildDraft(resultList);
  const options = (mIn || []).map(m => `<option value="${m.name}">${m.name}（${m.category}）</option>`).join('');
  const rowsHtml = aiInDraft.map((r, idx) => {
    const m = (mIn || []).find(x => x.name === r.targetName);
    const units = m ? ((m.unitOptions && m.unitOptions.length) ? m.unitOptions : [m.unit]) : [];
    const unitOptions = units.map(u => `<option value="${u}" ${u === r.inputUnit ? 'selected' : ''}>${u}</option>`).join('');
    const statusColor = r.status === '一致' ? '#2e7d32' : (r.status === '候補' ? '#ef6c00' : '#c62828');
    return `
      <div class="ai-in-row" data-idx="${idx}" style="border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:8px;">
        <div style="font-size:12px; color:#666; margin-bottom:6px;">AI: <b>${r.aiName}</b> <span style="color:${statusColor}; font-weight:800;">[${r.status}]</span></div>
        <label style="margin-top:0;">マスタ候補</label>
        <select class="ai-target" onchange="aiInOnTargetChange(this)"><option value="">-- 未該当（スキップ） --</option>${options}</select>
        <label>数量</label>
        <input type="number" class="ai-qty" value="${r.qty}">
        <label>入力単位</label>
        <select class="ai-unit">${unitOptions}</select>
      </div>
    `;
  }).join('');

  const html = `
    <div style="font-weight:800; text-align:center; margin-bottom:15px; color:#333; font-size:18px;">解析結果</div>
    <p style="font-size:12px; color:#666; text-align:center; margin-bottom:15px;">候補・数量・単位を修正して登録してください（未該当はスキップ）</p>
    <div id="ai-in-rows" style="max-height: 300px; overflow-y: auto; padding: 5px;">${rowsHtml}</div>
    <div style="margin-top:20px;">
      <button class="btn-main" onclick="executeAIInFromModal()">登録する</button>
      <button class="btn-cancel" onclick="closeModal()">戻る</button>
    </div>
  `;
  openModal(html);
  const rows = document.querySelectorAll('#ai-in-rows .ai-in-row');
  rows.forEach((row, idx) => {
    const sel = row.querySelector('.ai-target');
    sel.value = aiInDraft[idx].targetName || '';
  });
}

function aiInOnTargetChange(sel) {
  const row = sel.closest('.ai-in-row');
  if (!row) return;
  const unitSel = row.querySelector('.ai-unit');
  const m = (mIn || []).find(x => x.name === sel.value);
  const units = m ? ((m.unitOptions && m.unitOptions.length) ? m.unitOptions : [m.unit]) : [];
  unitSel.innerHTML = units.map(u => `<option value="${u}">${u}</option>`).join('');
}

function executeAIInFromModal() {
  const rows = Array.from(document.querySelectorAll('#ai-in-rows .ai-in-row'));
  const dataList = rows.map(row => ({
    targetName: row.querySelector('.ai-target').value,
    qty: Number(row.querySelector('.ai-qty').value || 0),
    inputUnit: row.querySelector('.ai-unit').value
  })).filter(x => x.targetName && x.qty > 0);

  if (dataList.length === 0) {
    alert('登録対象がありません（未該当はスキップされます）');
    return;
  }
  closeModal();
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(res => {
    load(false);
    toast(res);
    aiReceiptBase64 = '';
    const f = document.getElementById('cam-in');
    if (f) f.value = '';
  }).processAIInflow(dataList);
}

function confirmManualIn() {
  const name = document.getElementById('manual-in-name').value;
  const qty = document.getElementById('manual-in-qty').value;
  const inputUnit = document.getElementById('manual-in-input-unit').value;
  const m = mIn.find(x => x.name === name);
  if (!qty || !m) return;

  const html = `
    <div style="font-weight:800; text-align:center; margin-bottom:20px; color:#333; font-size:18px;">入庫確認</div>
    <div style="background:#f9f9f9; padding:18px; border-radius:16px; font-size:14px; color:#444; border: 1px solid #eee; text-align:center;">
      <div style="font-weight:800; margin-bottom:10px; font-size:16px;">${name}</div>
      <div><span style="color:var(--main-blue); font-size:24px; font-weight:800;">+ ${qty}</span><span style="font-size:14px; font-weight:800; color:#777;"> ${inputUnit}</span></div>
    </div>
    <div style="margin-top:20px;">
      <button class="btn-main" onclick="executeManualIn('${name}', ${qty}, '${inputUnit}')">登録する</button>
      <button class="btn-cancel" onclick="closeModal()">キャンセル</button>
    </div>
  `;
  openModal(html);
}

function executeManualIn(name, qty, inputUnit) {
  closeModal();
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(res => {
    load(false);
    toast(res);
    document.getElementById('manual-in-qty').value = '';
  }).processInflowFromUI({ name: name, qty: qty, inputUnit: inputUnit, memo: '手動入庫', isSet: false });
}
</script>


