<div class="section-title">Square 売上CSV</div>
<div class="section-body">
  <div class="camera-box" onclick="document.getElementById('file-out').click()">
    <div style="font-size: 32px; margin-bottom: 5px;">📄</div>
    <div style="font-weight: 800; color: #555; font-size: 14px;">CSVをアップロード</div>
    <div style="font-size: 10px; color: #999; margin-top: 3px;">売上数から在庫減算を自動作成します</div>
    <input type="file" id="file-out" accept=".csv" style="display:none;" onchange="analyzeSquare(this)">
  </div>
</div>

<div class="section-title" style="margin-top: 30px;">手動廃棄登録</div>
<div class="section-body">
  <div class="card">
    <div style="flex: 2;">
      <label>アイテム</label>
      <select id="waste-name" onchange="updateWasteUnit()"></select>
      <div style="margin-top:8px;">
        <label>数量</label>
        <div class="qty-input-box">
          <input type="number" id="waste-qty" value="">
          <span id="waste-unit" class="unit-label">--</span>
        </div>
        <select id="waste-input-unit" style="margin-top:8px;"></select>
      </div>
    </div>
    <div style="flex: 1; display: flex; justify-content: flex-end;">
      <button class="btn-action btn-waste" style="border-color:var(--red-text); background:var(--red); color:var(--red-text);" onclick="confirmWaste()">廃棄登録</button>
    </div>
  </div>
</div>
<script>
let outBuffer = null;
let masterOut = [];

function refreshOutflow() {
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(d => {
    load(false);
    masterOut = d.masterWithUnits || [];
    document.getElementById('waste-name').innerHTML = masterOut.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
    updateWasteUnit();
  }).getInitialData();
}

function updateWasteUnit() {
  const m = masterOut.find(x => x.name === document.getElementById('waste-name').value);
  document.getElementById('waste-unit').innerText = m ? m.unit : '--';
  const units = (m && Array.isArray(m.unitOptions) && m.unitOptions.length > 0) ? m.unitOptions : (m ? [m.unit] : ['--']);
  document.getElementById('waste-input-unit').innerHTML = units.map(u => `<option value="${u}">${u}</option>`).join('');
}

function analyzeSquare(input) {
  const f = input.files[0];
  if (!f) return;
  load(true);
  const reader = new FileReader();
  reader.onload = e => {
    google.script.run.withFailureHandler(handleGsError).withSuccessHandler(res => {
      load(false);
      outBuffer = res.reductions;
      showSquareResultPopup(res.reductions || {});
    }).analyzeSalesCSV(e.target.result);
  };
  reader.readAsText(f);
}

function showSquareResultPopup(reductions) {
  let itemsHtml = '';
  for (let k in reductions) {
    itemsHtml += `
      <div style="background:#fff; border:1px solid #eee; padding:12px; border-radius:12px; margin-bottom:10px; display:flex; align-items:center; gap:10px;">
        <div style="flex:2;">
          <div style="font-size:13px; font-weight:800; color:#444;">${k}</div>
          <div style="color:var(--red-text); font-weight:800;">- ${reductions[k].qty} <span style="font-size:11px; color:#777;">${reductions[k].unit}</span></div>
        </div>
      </div>
    `;
  }

  const html = `
    <div style="font-weight:800; text-align:center; margin-bottom:15px; color:#333; font-size:18px;">売上解析結果</div>
    <p style="font-size:12px; color:#666; text-align:center; margin-bottom:15px;">CSVの内容から在庫減算を作成します</p>
    <div style="max-height: 250px; overflow-y: auto; padding: 5px;">${itemsHtml || '<div style="font-size:12px;color:#888;">データがありません</div>'}</div>
    <div style="margin-top:20px;">
      <button class="btn-main btn-danger" style="background:var(--red-text);" onclick="registerOutFinal()">出庫を登録</button>
      <button class="btn-cancel" onclick="closeModal()">キャンセル</button>
    </div>
  `;
  openModal(html);
}

function registerOutFinal() {
  closeModal();
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(msg => {
    load(false);
    toast(msg);
  }).registerOutflowFinal(outBuffer || {});
}

function confirmWaste() {
  const name = document.getElementById('waste-name').value;
  const qty = document.getElementById('waste-qty').value;
  const inputUnit = document.getElementById('waste-input-unit').value;
  const m = masterOut.find(x => x.name === name);
  if (!name || !qty || !m) return;

  const html = `
    <div style="font-weight:800; text-align:center; margin-bottom:20px; color:var(--red-text); font-size:18px;">廃棄登録の確認</div>
    <div style="background:#fff5f5; padding:18px; border-radius:16px; font-size:14px; color:#444; border: 1px solid var(--red); text-align:center;">
      <div style="font-weight:800; margin-bottom:10px; font-size:16px;">${name}</div>
      <div><span style="color:var(--red-text); font-size:24px; font-weight:800;">- ${qty}</span><span style="font-size:14px; font-weight:800; color:#777;"> ${inputUnit}</span></div>
    </div>
    <div style="margin-top:20px;">
      <button class="btn-main btn-danger" style="background:var(--red-text);" onclick="executeWaste('${name}', ${qty}, '${m.category}', '${m.unit}', '${inputUnit}')">登録する</button>
      <button class="btn-cancel" onclick="closeModal()">キャンセル</button>
    </div>
  `;
  openModal(html);
}

function executeWaste(name, qty, category, unit, inputUnit) {
  closeModal();
  load(true);
  google.script.run.withFailureHandler(handleGsError).withSuccessHandler(() => {
    load(false);
    toast('廃棄を登録しました');
    document.getElementById('waste-qty').value = '';
  }).processInventoryAdjustment(name, qty, 'waste', category, unit, inputUnit);
}
</script>


